Часть первая: <a href="http://habrahabr.ru/post/268863/">Google Cloud Endpoints на Java: Руководство. ч. 1</a>

В первой части мы рассмотрели создание проекта на <a href="https://cloud.google.com/appengine/docs/java/endpoints/">Google Cloud Endpoints с Java</a>, в этой статье речь пойдет о создании фронт-энда к нашему API.

В дополнение к инструментам использовавшимся в первой части нам понадобиться:

<a href="https://angularjs.org/">AngularJS</a> , опционально <a href="http://getbootstrap.com/">Bootstrap</a> или <a href="http://foundation.zurb.com/">Foundation</a>.

Простейший веб-сервер на локальной машине для тестирования, и сервер для деплоя приложения.

<cut>

<h1>Локальный сервер</h1>
Приложение на AngularJS состоит из обычного набора "статических" файлов: .html, .js, .css + файлы изображений, шрифты и т.п. Казалось бы, поскольку это как правило одностраничное приложение, можно просто открыть index.html в браузере. Однако при попытке просто открыть index.html в Google Chrome мы можем увидеть страницу без основного содержания и в консоли нечто вроде этого:

<img src="https://habrastorage.org/getpro/habr/post_images/206/63b/3d0/20663b3d045db2775269310fdeabf905.png" alt="image"/>

В Firefox тоже приложение может работать без веб-сервера, но ссылки вида src="//...  или href="... превращаются в file:///...
Ну и <a href="https://developers.google.com/web/tools/chrome-devtools/">Chrome DevTools</a>, как мой вкус гораздо удобнее.

Поэтому использовать веб-сервер на локальной машине будет все же предпочтительныее. Можно использовать <a href="http://www.sinatrarb.com/">Sinatra</a> на Ruby, <a href="https://nodejs.org">NodeJS</a>, старый добрый <a href="https://httpd.apache.org/">Apache HTTP Server ("httpd")</a>. App Engine Java SDK также включает development web server запускаемый на локальной машине, и имитирующий сервисы сервиса GAE включая базу данных (datastore).
В IntelliJ IDEA при редактировании .html файла высвечиваются иконки браузеров, если клинуть то файл откроется на локальном веб-сервере запущенном IntelliJ IDEA.

На мой взгляд самым простым и универсальным вариантом является Python (тем более, что он у Вас скорее всего уже установлен):
<source lang="bash">
python -m SimpleHTTPServer <port>
</source>
в данном случае "python" означает запуск Python версии 2.x (по умолчанию), "-m" - запуск <a href="https://docs.python.org/2/using/cmdline.html#cmdoption-m">модуля</a>, "<a href="https://docs.python.org/2/library/simplehttpserver.html">SimpleHTTPServer</a>" - собственно модуль представляющий собой простейший http-сервер и входящий в стандарную установку (т.е. если у Вас установлен Python, то этот модуль уже присуствует), опционально <port> - номер порта, если этот параметр не указывать, то по умолчанию будет 8000.
<i>Эту команду надо исполнить в директории проекта, там где находится наш index.htm</i>l, который и будет отдаваться по умолчанию в / на вебсервере, и на http://localhost:8000/ (http://127.0.0.1:8000/) получаем статический http-сервер. Удобно тем что никаких настроек в самой директории, и вообще больше никаких настроек не нужно.

<h1> Деплой</h1>
Разместить фронт-энд веб-приложение для нашего API можно на любом веб-сервере на котором можно размещать статичные файлы, например на бесплатном <a href="https://pages.github.com/">GitHub Pages</a> (см. также <a href="https://help.github.com/articles/setting-up-a-custom-domain-with-github-pages/">Setting up a custom domain with GitHub Pages</a>)  или на <a href="http://aws.amazon.com">Amazon Web Services (AWS)</a>.

Естественно логичным решением является и размещене фронтенда на GAE. Это может быть в одном проекте. В нашем руководстве, в учебных целях, мы разместитим бэк-энд и фронт-энд в разных проектах на GAE. В предыдущей части мы создали для этого два проекта в консоли разработчика. Фронтенд будет жить проекте в hello-habrahabr-webapp, а бэкенд в hello-habrahabr-api.

<h2>Домен</h2>
В дополнение к имеющемуся доменному имени вида {проект ID}.appspot.com, мы можем использовать собственный домен зарегистрированный как через <a href="https://domains.google.com">Google Domains</a>, так и у другого регистратора, или несколько доменов для одного проекта. Ранее эта возможность была доступна только для доменов используемых в <a href="https://www.google.com/work/apps/business/">Google Apps</a>, но с недавнего времени привязка к  Google Apps убрана.

Для того чтобы добавить домен, выбираем проект в консоли разработчика и переходим в меню: Compute -> App Engine -> Settings -> Custom domains. Затем выбираем 'Register a new domain' чтобы зарегистрировать домен у Google, или если у нас уже есть домен 'Add a custom domain'

<img src="http://" alt="image"/>
/Selection_002.png

Если мы добавляем домен зарегистрированный не у Google, то сначала надо пройти проверку что вы собственник домена и добавить домен в список проверенных на для вашей учетной записи google: вписываем доменное имя в поле обозначенное цифрой 1, нажимаем 'Verify' и переходим на страницу верификации:

/Selection_003.png

если домен зарегистрирован у godaddy.com или другого крупного до для верификации нужно выбрать провайдера и и открывшемся окне залогиниться:

/Selection_004.png

и подтвердить:

/Selection_005.png

/Selection_006.png

/Selection_007.png

Либо сделать верификацию вручную, инструкции будут показаны по клику на 'Add a TXT record.'

На странице:

/Selection_008.png

можно добавить "свойства" верифицированных доменов, например добавить дополнительную учетную запись google с которой можно управлять доменом в сервисах Google.

После верификации домена, в разделе обозначенном цифрой 2. (если мы только что добавили новый домен, то нужно перегрузить страницу, чтобы новый домен стал доступен для выбора) мы можем присвоить этот домен текущему проекту, либо "целиком", либо создать и присвоить субдомен, либо и то и другое.

/Selection_009.png

После выбора домена и нажатия кнопки 'Add', следует внести изменения в настройки домена у регистратора (DNS Zone File) согласно инструкциям указанным в разделе под цифрой 3:

/Selection_010.png

Внимание: после нажатия кнопки 'Add' визуально ничего не отражается, надо перейти в другой раздел (например 'Application settings'), и снова вернуться в 'Custom domains' - теперь там должны быть показанны добавленные (суб)домены и их настройки.

Теперь проект будет (не сразу, а в течении времени до 24 часов) доступен как по адресу {проект ID}.appspot.com , так и по добавленным адресам (доменам).

<h1>Настройка SSL</h1>

Доступ к адресу {проект ID}.appspot.com может осуществляться как по http так и https
Для того чтобы обеспечить доступ по https к собственному домену, нам потребуется SSL-сертификат подписанный удостоверяющий центром (англ. Certification authority, CA) подпись которого принимается браузерами.
Ведущими <a href="https://en.wikipedia.org/wiki/Certificate_authority#Providers">провайдерами</a> услуг удостоверяющего центра в настоящее время являются <a href="http://www.symantec.com">Symantec</a> с брендами <a href="https://www.geotrust.com">GeoTrust</a>, <a href="https://www.thawte.com/">Thawte</a>, <a href="https://www.symantec.com/ssl-certificates/">Verisign</a>, тот же <a href="https://www.godaddy.com/web-security/ssl-certificate">Godaddy</a>, и <a href="https://www.comodo.com/">Comodo</a>. Наибольшая доля рынка, и более низкие цены у Comodo. Если приобретать сертификаты через реселлеров цена обычно еще ниже.
Для начала/обучения можно воспользоваться <a href="https://www.comodo.com/e-commerce/ssl-certificates/free-ssl-certificate.php">бесплатным сертификатом от Comodo на 90 дней</a> (бесплатно выдается один раз на домен) и/или аналогичным предложением на 30 дней от <a href="https://www.freessl.com/">RapidSSL</a>.

Для того чтобы получить сертификат нужно направить провайдеру <a href="https://en.wikipedia.org/wiki/Certificate_signing_request">certificate signing request (CSR)</a> (запрос на подпись сертификата). Некоторые сервисы предлагают генерацию сертификата на сайте, однако в таком случае нет гарантии что секретный ключ будет только у вас, поэтому CSR лучше сгенерировать самостоятельно. Для этого воспользуемся утилитой <a href="https://www.openssl.org/">OpenSSL</a>.

Сначала создадим файл конфигурации для CSR ( назовем его scr.conf ) :
<source lang="bash">
# csr.conf
# you can rename scr.conf, scr.key, scr.csr to filenames you prefer,
# but with the same filename extensions
[req]
default_bits       = 2048 #
default_md         = sha512
default_keyfile    = csr.key #name of keyfile
distinguished_name = req_distinguished_name
prompt             = yes
# If 'prompt = no' provide right values to properties, not to _default properties
# and remove or comment _default properties.
# Use 'yes' and _default to see and correct values interactively
encrypt_key        = no #
# req_extensions = v3_req           #this is for multi-domain certificate

[req_distinguished_name]
#
# Use your company name, e-mai, domain names as default values
# if you enter '.', the field will be left blank
#
countryName = Country Name (2 letter code)
countryName_default = GB
stateOrProvinceName = State or Province Name (full name)
stateOrProvinceName_default = City of London
localityName = Locality Name (eg, city)
localityName_default = London
organizationName = Organization name
organizationName_default = MyCompany Limited
organizationalUnitName = Organizational Unit Name (eg, section)
organizationalUnitName_default = .
commonName = This is fully qualified domain name that you wish to secure
# e.g. www.example.com or mail.example.com
commonName_default = www.my-domain.com
emailAddress = Email Address
emailAddress_default = admin@my-domain.com

# [v3_req]
# subjectAltName = @alt_names       #this is for multi-domain certificate

# [alt_names]                       #this is for multi-domain certificate
# DNS.1   = my-domain.net           #this is for multi-domain certificate
# DNS.2   = my-domain.org           #this is for multi-domain certificate
# DNS.3   = myseconddomain.com      #this is for multi-domain certificate

# to generate .csr:
# openssl req -newkey rsa:2048 -sha512 -out csr.csr -config csr.conf
# or:
# openssl req -newkey rsa:2048 -sha512 -nodes -out csr.csr -config csr.conf
# Note:  If the "-nodes" is entered the key will NOT be encrypted with a
# DES pass phrase, ( see:
# https://support.comodo.com/index.php?/Default/Knowledgebase/Article/View/1/19/csr-generation-using-openssl-apache-wmod_ssl-nginx-os-x
# )
#
# to verify .csr:
# openssl req -text -noout -verify -in csr.csr
#
# in one command generate and verify:
# openssl req -newkey rsa:2048 -out csr.csr -config csr.conf && openssl req -text -noout -verify -in csr.csr
#

</source>

теперь запустим команду:

<source lang="bash">
openssl req -newkey rsa:2048 -out csr.csr -config csr.conf
</source>

если в настройках мы указали 'prompt = yes', то у нас есть возможность просмотреть вводимые заначения и изменять их. Если не нужно менять значения указанные по умолчению, то просто жмем 'Enter'

В результате мы создадим два новых файла: csr.key - это приватный ключ, и csr.csr - это CSR (запрос на подпись сертификата)

проверить CSR можно командой:
<source lang="bash">
openssl req -text -noout -verify -in csr.csr
</source>
Файл .csr нужно открыть текстовым редактором, внутри будет нечто вроде:
<source lang="bash">
-----BEGIN CERTIFICATE REQUEST-----
MIIC5TCCAc0CAQAwgZ8xCzAJBgNVBAYTAkdCMRcwFQYDVQQIDA5DaXR5IG9mIExv
bmRvbjEPMA0GA1UEBwwGTG9uZG9uMRowGAYDVQQKDBFNeUNvbXBhbnkgTGltaXRl
NZBB4bDdgJ+uyNZq54dM1tUvzSolv/+LAY78/z85edqLH4nc5CxgMEn8hurFOpB4
RXS+ShhpBsJr6RJhSk2xkRe/idkM/TUon/7n1TUthFpjv2tYQZ6on3iWUZ61FDuM
mNPHGMIX+sn/OceViRtlu1Lx+t4JV9dTJQ==
-----END CERTIFICATE REQUEST-----
</source>
Содержание файла нужно будет скопировать, и вставить в форму на сайте, примерно такую:

/Selection_011.png

Для простейшей проверки владения доменом у вас должен быть  доступ к e-mail который выдает whois, либо к одному из email адресов в данном домене:
admin@
administrator@
postmaster@
hostmaster@
webmaster@

Либо нужно разместить http://yourdomain.com/<Upper case value of MD5 hash of CSR>.txt или модифицировать DNS CNAME record указав опять же соотвествующий хэш.

Расширенная проверка: Extended Business Verification или сокращенно EV, требует предоставления документов организации, на которую выдается сертификат, но позволяет получить сертификат с "зеленой строкой"  (GreenBar) в браузере в которой отражается имя организации - владельца сертификата.

После прохождения проверки вы сможете сгрузить с сайта провайдера или получить по электронной почте файл вида {ваш domain или номер заказа}.crt , обычно в пакете (.zip) c сертификатами сертификационного центра. Последние нам в данном случае не подадобяться.

Наш сертификат мы можем проверить и просмотреть содержащуюся в нем информацию командой:
<source lang="bash">
openssl x509 -in {имя файла}.crt -text -noout
</source>
где {имя файла}.crt - имя нашего файла сертификата.


Подробнее о настройке домена и SSL в GAE на https://cloud.google.com/appengine/docs/using-custom-domains-and-ssl


<img src="http://" alt="image"/>
